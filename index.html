<!DOCTYPE html>
<html><meta charset="utf-8">
 <head><title>Achaea Sailing Map 2.0</title>
  <link rel='icon' type='image/png' href='./core/resources/icon.png' />
  <script src='./core/extlib/jquery-3.1.1.js'></script>
  <script src='./core/extlib/d3.v4.min.js'></script>
  <script src='./core/extlib/topojson.js'></script>
  <script src='./core/extlib/jquery.simulate.js'></script>
  <script src='./core/extlib/jquery.simulate.ext.js'></script>
  <script src='./core/extlib/jquery.simulate.drag-n-drop.js'></script>
  <script src='./core/asm.js'></script>
  <script src='./core/asm.data.js'></script>
  <script src='./core/asm.data.mainland.js'></script>
  <script src='./core/asm.data.mainland.internal.js'></script>
  <script src='./core/asm.data.roughs.js'></script>
  <script src='./core/asm.data.zanzibaar.js'></script>
  <style>
document, body { padding: none; margin: none; background: rgba(14,14,104,0.24); overflow: hidden; }
#coords {
 position: absolute; z-index: 100; top: 0px; right: 0px; width: 140px; height: 32px; color: rgba(145,145,145,1); background: rgba(15,15,15,0.75); border: none; border-left: 2px solid rgba(212,212,2121,1); border-bottom: 2px solid rgba(212,212,2121,1); border-radius: 4px; }
#text {
 font-size: 11pt; text-align: center; line-height: 32px; height: 100%; width: 100%; user-select: none; }
#leader {
 position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);border:3px solid rgba(255,122,122,1);border-radius:450%; }
#tracer-x { left:0px;height:1px;width:100%;z-index:-15;}
#tracer-y { top:0px;width:1px;height:100%;z-index:-15;}
.tracer { position:absolute;background:rgba(214,14,14,1);}
.hidden { display: none; }
#tooltip {
 padding: 0.4em; background: rgba(1,1,1,0.4); border: none; border-radius: 5px; color: rgba(200,200,200,0.88); }
#settings {
 position: absolute; top: 35px; left: 140px; height: 450px; width: 450px; background: rgba(15,15,15,0.56); border-bottom-left-radius: 4px; border-top-left-radius: 4px; transition: all 430ms; }
#pin {
 position: absolute; top: 5px; left: 5px; height: 20px; width: 20px; background: rgba(255,255,255,0); background-size: 20px 20px; background-repeat: no-repeat; cursor: pointer; transition: all 80ms; }
canvas {
 background: rgba(20,60,135,0.93);
 position: absolute;
 left: 50%;
 top: 50%;
 transform: translate(-50%,-50%);
}
  </style>
 </head>
   <canvas id="map" width="960" height="500">
   </canvas>
   <div id="coords">
   <div id="text"></div> 
   <div id="settings"><div id="pin"></div></div>
   </div>
   <div id="tracer-x" class="tracer hidden"></div>
   <div id="tracer-y" class="tracer hidden"></div>
<script>

// options
opt_maximal     = true                 // scale to window
opt_tracer      = false                // tracer for logging coordinates/widths & crosshairs
opt_unitWidth   = 4
opt_unitHeight  = 6
opt_hoverRadius = 6
opt_gridnum     = 20000

// helper functions
clean = function(n) { var x = Number(n.replace(/[^-\d\.]/g, '')); return x }
log   = console.log
// alias functions
copy  = asm.copy
draw  = asm.draw

// helper variables
var_hovr  = false
var_hvrg  = {}
var_json  = {}
var_pind  = false        // ui 
var__cord = [ 344, 356]  // ui, start coordinates
var__zoom = 0.74         // ui, start zoom

// grab data
var_json = copy(asm.data.topoj)
var_json.transform.scale = [opt_unitWidth, opt_unitHeight]

$(window).on( 'load', function() {
  log(var_json)

  zoom = function() { 
    var context  = canvas.node().getContext('2d'); context.clearRect(0, 0, canvas.property('width'), canvas.property('height')); 
    draw(context, d3.event.transform, var_json) }

  var z       = d3.zoom().scaleExtent([ 1/27 /* zoom out */, 85 ])
  var canvas  = d3.select('canvas').call(z.on('zoom', zoom))
  var context = canvas.node().getContext('2d')
  var r       = d3.zoomIdentity
    if (opt_maximal) {
    context.canvas.width = window.innerWidth
    context.canvas.height = window.innerHeight } // only AFTER window has loaded, for accurate positioning
  var n       = document.getElementById('map').getBoundingClientRect() // !NOTE: #map 

  draw(context, d3.zoomIdentity, var_json)  // !important
  $('#coords').css('top', n.top).css('right', n.left)
  $(document).on( 'mousemove', fnc_mousemove)
  fnc_settings()

  // Final Preparation, Move & Zoom
  //  Simulate & Starting Position
  //  Simulate drag to starting coordinates
    $('canvas').simulate("drag-n-drop", {
       dx: $('canvas').width() / 2 - ( var__cord[0] * opt_unitWidth), 
       dy: $('canvas').height() / 2 + ( var__cord[1] * opt_unitHeight),
    });
  //  Simulate zoom
    z.scaleTo(canvas,var__zoom)
})

fnc_mousemove = function(e) {
  var f = document.getElementById('map').getBoundingClientRect()
  var r = d3.zoomTransform(d3.select('canvas').node())
  var s = ''
  
  var coords = asm.mouseCartesian(r,e,f)
  var x = Math.round(coords[0])
  var y = Math.round(coords[1])
  
  $('#text').text(' X : '+x+' | Y : '+y)
  
  if (opt_tracer) {
    $('.tracer').removeClass('hidden')
    $('#tracer-x').css('top',e.clientY)
    $('#tracer-y').css('left',e.clientX)
    s = s + ', #map top (orig): ' + f.top
    s = s + ', (0,0) top: '+r.y }
  
  s = 'Cursor position: x '+ e.clientX+', '+e.clientY + s
  // log(s)
  // change the spot coordinate into window-pixels
  // change that spot into a range
  // test against my mouse
  asm.mousehover(r,e,f)
}

fnc_settings = function() {
  // Handle settings
  var g = clean($('#settings').css('width')) - clean($('#coords').css('width'))
  if (var_pind) {
    $('#pin').css('background-image','url("./core/resources/pin_active.png")')
    $('#settings').css('left',  -g + 'px' )
  } else {
    $('#pin').css('background-image','url("./core/resources/pin_inactive.png")')
  }

  $('#coords').on('mouseenter', function() {
    // Handle slightly differently, given
    $('#settings').css('left',  -g + 'px' )
  }).on('mouseleave', function() {
    if (!var_pind) { $('#settings').css('left', clean($('#coords').css('width'))+'px') }
  })
  $('#pin').on('mouseenter', function() {
    if (!var_pind) {
      $('#pin').css('background-image', 'url("./core/resources/pin_inactive_hover.png")' )
    } else {
      $('#pin').css('background-image', 'url("./core/resources/pin_active_hover.png")' )
    }
  }).on('mouseleave', function() {
    if (!var_pind) {
      $('#pin').css('background-image', 'url("./core/resources/pin_inactive.png")' )
    } else {
      $('#pin').css('background-image', 'url("./core/resources/pin_active.png")' )
    }
  }).on('click', function() {
    if (!var_pind) { 
      var_pind = true
      $('#pin').css('background-image', 'url("./core/resources/pin_active_hover.png")' )
    } else { 
      var_pind = false 
      $('#pin').css('background-image', 'url("./core/resources/pin_inactive_hover.png")' )
    }
  })
}

</script>
<!-- <div>Icons made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div> -->
<!-- <div>Icons made by <a href="https://www.flaticon.com/authors/simpleicon" title="SimpleIcon">SimpleIcon</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div> -->
